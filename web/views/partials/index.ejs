<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librer√≠a - Inicio</title>

    <script type="module">
        import { getCurrentUser, logout } from "/js/auth.mjs";
        const user = getCurrentUser();
        console.log(user);
    </script>

    <link rel="stylesheet" href="css/main.css">

    <style>
        /* Reducimos el ancho del contenedor del bot√≥n */
        .carousel-control-prev,
        .carousel-control-next {
            width: 5%;
            /* Bootstrap por defecto usa 15% */
            z-index: 10;
            /* Asegura que est√© por encima pero sin estorbar */
        }

        /* Opcional: Si quieres que las flechas sean m√°s visibles 
   ya que ahora el √°rea es m√°s peque√±a */
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.5);
            /* Fondo oscuro semitransparente */
            border-radius: 50%;
            padding: 15px;
            background-size: 60%;
        }

        /* Evitamos que el bot√≥n capture clics fuera del icono visual */
        .carousel-control-prev,
        .carousel-control-next {
            pointer-events: none;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            pointer-events: auto;
            /* Solo el icono responde al clic */
        }

        .publisher-logo-container {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 50%;
            /* O '8px' si prefieres cuadrados redondeados */
            padding: 15px;
            /* Espacio para que el logo no toque los bordes */
            overflow: hidden;
        }

        .publisher-logo-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            /* Mantiene la proporci√≥n del SVG/Imagen sin deformar */
        }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <%- include('../layout/header') %>
        <div class="container py-5">

            <header class="mb-5">
                <p class="lead mt-3">Descubre los mejores libros y autores del momento</p>

                <div class="d-flex flex-wrap gap-2 mt-3">
                    <% genresMostSold.forEach(genre=> { %>
                        <span class="badge rounded-pill bg-light text-dark border p-2">
                            <i class="bi bi-tag-fill text-primary"></i>
                            <a href="/genres/<%= genre.name %>" class="text-decoration-none">
                                <%= genre.name %>
                            </a>
                            <span class="ms-1 fw-bold text-primary">
                                <%= genre.totalSold %>
                            </span>
                        </span>
                        <% }) %>
                </div>
            </header>

            <section class="mb-5 bg-white p-4 rounded shadow-sm">
                <h2 class="section-title text-center mb-4"><i class="bi bi-graph-up-arrow text-danger"></i> Libros m√°s
                    vendidos</h2>
                <div class="row row-cols-1 row-cols-md-5 g-3">
                    <% booksMostSold.forEach((book, index)=> { %>
                        <div class="col">
                            <div class="card h-100 border-0 text-center">
                                <div class="position-absolute top-0 start-0 badge bg-danger m-2">#<%= index + 1 %>
                                </div>
                                <img src="<%= book.cover_url || '/images/default-cover.jpg' %>"
                                    class="card-img-top rounded mx-auto" style="height: 150px; width: fit-content;"
                                    alt="<%= book.title %>">
                                <div class="card-body p-2">
                                    <p class="small fw-bold mb-0 text-truncate">
                                        <a href="/books/book/<%= book.id %>" class="text-decoration-none">
                                            <%= book.title %>
                                        </a>
                                    </p>
                                    <span class="badge bg-light text-muted border text-dark">
                                        <%= book.totalSold %> vendidos
                                    </span>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                </div>
            </section>

            <section class="mb-5">
                <h2 class="section-title text-center">Libros Destacados</h2>

                <% if (books && books.length> 0) { %>
                    <div id="booksCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner" id="carouselInner">
                            <% const booksPerSlide=4; for (let i=0; i < books.length; i +=booksPerSlide) { const
                                group=books.slice(i, i + booksPerSlide); const isActive=i===0 ? "active" : "" ; %>
                                <div class="carousel-item <%= isActive %>">
                                    <div class="row justify-content-center">
                                        <% group.forEach(book=> { %>
                                            <div class="col-md-3 mb-4">
                                                <div class="card h-100 shadow-sm book-card">
                                                    <img src="<%= book.cover_url || '/images/default-cover.jpg' %>"
                                                        class="card-img-top" alt="<%= book.title %>">
                                                    <div class="card-body d-flex flex-column">
                                                        <h5 class="card-title text-truncate">
                                                            <%= book.title %>
                                                        </h5>
                                                        <p class="card-text text-muted small">
                                                            <strong>Autor:</strong>
                                                            <% const relations=bookAuthors.filter(ba=>
                                                                Number(ba.book_id) === Number(book.id));

                                                                if (relations.length > 0) {
                                                                relations.forEach((ba, index) => { %>
                                                                <a href="/author/<%= ba.author_id %>"
                                                                    class="text-decoration-none">
                                                                    <%= ba.author ? ba.author.name : "Desconocido" %>
                                                                </a>
                                                                <%= index < relations.length - 1 ? ', ' : '' %>
                                                                    <% }); } else { %>
                                                                        Desconocido
                                                                        <% } %>
                                                        </p>
                                                        <p class="card-text fw-bold text-primary mt-auto">
                                                            <%= book.price %>‚Ç¨
                                                        </p>
                                                        <a href="/books/book/<%= book.id %>"
                                                            class="btn btn-primary btn-sm mt-2">
                                                            Ver detalles
                                                        </a>
                                                        <form action="/cart/add" method="POST" class="d-inline">
                                                            <input type="hidden" name="book_id" value="<%= book.id %>">
                                                            <div class="input-group input-group-sm"
                                                                style="width: 120px;">
                                                                <label for="quantity">Cantidad: </label>
                                                                <input type="number" name="quantity" value="1" min="1"
                                                                    max="<%= book.stock %>" class="form-control"
                                                                    <%=book.stock <=0 ? 'disabled' : '' %>>
                                                                <button type="submit" class="btn btn-success"
                                                                    <%=book.stock <=0 ? 'disabled' : '' %>
                                                                    title="<%= book.stock <=0 ? 'Sin stock'
                                                                        : 'A√±adir al carrito' %>">
                                                                        A√±adir al carrito üõí
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }) %>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#booksCarousel"
                            data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#booksCarousel"
                            data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Siguiente</span>
                        </button>
                    </div>
                    <% } else { %>
                        <p class="text-center text-muted">No hay libros destacados en este momento.</p>
                        <% } %>
            </section>

            <div class="row">
                <div class="col-md-8">
                    <section class="mb-5">
                        <h2 class="section-title text-center">Autores Destacados</h2>
                        <% if (authors && authors.length> 0) { %>
                            <div class="row justify-content-center">
                                <% authors.forEach(author=> { %>
                                    <% const countData=bookAuthorsCount.find(item=> Number(item.author_id) ===
                                        Number(author.id));
                                        const totalLibros = countData ? Number(countData.count_books) : 0; %>
                                        <div class="col-md-4 mb-4">
                                            <div class="card author-card text-center shadow-sm">
                                                <div class="card-body">
                                                    <img src="<%= author.photo_url || '/images/default-author.jpg' %>"
                                                        alt="<%= author.name %>" class="rounded-circle mb-2"
                                                        style="width: 80px; height: 80px; object-fit: cover;">
                                                    <h5 class="mt-3 small">
                                                        <%= author.name %>
                                                    </h5>
                                                    <p class="text-muted small">
                                                        <%= author.country || "Pa√≠s desconocido" %>
                                                    </p>
                                                    <span class="badge bg-secondary">Libros: <%= totalLibros %></span>
                                                    <a href="/author/<%= author.id %>"
                                                        class="btn btn-primary btn-sm mt-2">Detalles</a>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                            </div>
                            <% } %>
                    </section>
                </div>

                <div class="col-md-4">
                    <h3 class="h5 mb-3 text-center">Ranking de Autores</h3>
                    <div class="list-group shadow-sm mb-5">
                        <% authorsMostSold.forEach((author, index)=> { %>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><strong>
                                        <%= index + 1 %>.
                                    </strong>
                                    <a href="/author/<%= author.id %>" class="text-decoration-none">
                                        <%= author.name %>
                                    </a>
                                </span>
                                <span class="badge bg-info text-dark rounded-pill">
                                    <%= author.totalSold %> vendidos
                                </span>
                            </div>
                            <% }) %>
                    </div>
                </div>
            </div>

            <section>
                <h2 class="section-title text-center">Editoriales Destacadas</h2>

                <div class="row mb-3 justify-content-center">
                    <% publishersMostSold.forEach(pub=> { %>
                        <div class="col-md-2 col-6 text-center mb-3">
                            <div class="p-2 border rounded bg-white shadow-sm">
                                <p class="small fw-bold mb-0 text-truncate">
                                    <a href="/publisher/<%= pub.id %>">
                                        <%= pub.name %>
                                    </a>
                                </p>
                                <small class="text-success">
                                    <%= pub.totalSold %> ventas
                                </small>
                            </div>
                        </div>
                        <% }) %>
                </div>

                <% if (publishers && publishers.length> 0) { %>
                    <div class="row justify-content-center">
                        <% publishers.forEach(publisher=> { %>
                            <div class="col-md-3 mb-4">
                                <div class="card author-card text-center shadow-sm">
                                    <div class="card-body text-center">
                                        <img src="<%= publisher.image_url || '/images/default-author.jpg' %>"
                                            alt="<%= publisher.name %>">
                                        <h5 class="mt-3">
                                            <%= publisher.name %>
                                        </h5>
                                        <a href="/publisher/<%= publisher.id %>" class="btn btn-primary btn-sm mt-2">Ver
                                            detalles</a>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                    </div>
                    <% } %>
            </section>

        </div>

        <%- include('../layout/footer') %>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>